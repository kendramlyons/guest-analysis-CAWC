---
title: "CAWC Origins, Languages & Destinations Report"
author: "Kendra Lyons"
date: "3/11/2022"
output: html_document
---

```{r setup, include=FALSE}
library(ggrepel)
library(knitr)
library(tidyverse)
library(usmap)
opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## Data

### Dates: 1/26/21 to 1/20/22

```{r data, echo=FALSE}

individuals <- read_csv("data/individual_all_clean_1_20_22.csv")

countries <- drop_na(read_csv("data/country_counts_1.20.csv"))

languages <- drop_na(read_csv("data/language_counts_1.20.csv"))

destinations <- drop_na(read_csv("data/destination_counts_1.20.csv"))

```


## Countries of Origin

```{r countries, echo=FALSE}

# filter out countries with few arrivals
top_ctrys <- c("Venezuela", "Brazil", "Cuba", "Ecuador", "Mexico", "Nicaragua", "Haiti", "Colombia",  "Guatemala", "Peru", "Honduras", "India" ) # update when data is updated

# set plot theme
theme_set(theme_minimal(15)) 
#par(mfrow = c(1, 2))

# Country of Origin percentages
countries %>%
    filter(percent > .01) %>%
  ggplot(aes(y = reorder(country, percent),  
             x = percent)) +
  geom_col() +
  labs(title = "Arrivals by Origin Country", 
       y = element_blank(), 
       x = "Percent of Arrivals")

# Top 12 countries of origin FW
individuals %>%
  filter(country %in% top_ctrys) %>%
  ggplot(aes(x = arrival_date)) +
  geom_bar(show.legend = FALSE) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) +
  labs(title = "Daily Arrivals", 
       #subtitle = "Top 12 Countries of Origin", 
       x = element_blank(), 
       y = "Number of Individuals, Daily") + 
  scale_x_date(date_breaks = "1 month", 
               date_labels = "%b") + 
  facet_wrap(~factor(country, top_ctrys), scales = "free_y")



```

## Languages

```{r languages, echo=FALSE}
# plot language distribution 
languages %>%
  filter(percent > .01) %>% # greater than 1% of arrivals
  ggplot(aes(y = reorder(language, percent), 
             x = percent)) +
  geom_col() +
  labs(title = "Arrivals by Language", 
       y = element_blank(), 
       x = "Percent of Arrivals")+
  theme(axis.ticks = element_blank())

# plot arrivals of other language speakers over time
individuals %>%
  filter(language != "Spanish", 
         language != "Portuguese") %>%
  ggplot(aes(x = arrival_date, 
             y = language)) +
  geom_point(alpha = .2) +
  labs(x = element_blank(), 
       y = element_blank()) +
  scale_x_date(date_breaks = "1 month", 
               date_labels = "%b") 
  
```

## Destination States

MAKE A MAP!

```{r destmap, echo=FALSE}
# Add values of 0 for states with no travelers
destinations <- destinations %>%
  add_row(state_name = "Hawaii", n = 0, percent = 0.0) %>%
  add_row(state_name = "North Dakota", n = 0, percent = 0.0) %>%
  add_row(state_name = "Wyoming", n = 0, percent = 0.0) %>%
  rename("state" = state_name)

# get state centroids for labels
centroids <- read_csv("data/us_states_centroids.csv") %>%
  rename("state" = full)

# add centroid data to destination data
map_destinations <- centroids %>%
  left_join(destinations)

# plot data on U.S. map with descriptive labels
plot_usmap(data = destinations, 
           values = "n") +
  theme(legend.position = "right") +
  scale_fill_continuous(name = "Guests",
                        low = "white", 
                        high = "darkgreen") +
  geom_label_repel(data = map_destinations,
            aes(x = x,
                y = y,
                label = paste(abbr, n)),
            size = 3)

```

```{r states, echo=FALSE}
# vector with top (12) destination states
top_states <- c("Florida", "Massachusetts", "New York", "Texas", "New Jersey", "California", "Pennsylvania", "Georgia", "Connecticut", "Illinois", "Utah", "Tennessee")

destinations %>%
  filter(percent > .5) %>%
  ggplot(aes(y = reorder(state, percent), 
             x = percent)) +
  geom_col() +
  #theme(axis.text.x=element_text(angle=90, hjust=1, vjust=.5)) +
  labs(title = "Arrivals by Destination State", 
       y = element_blank(), 
       x = "Percent of Arrivals")

palette2 <- c("#687d34","#330073","#57dd65", "#94299a","#7fe7c2","#be0063","#00e3e0","#970015","#5d6ec4","#92b426","#4c0054","#ebd460","#d496c4","#008b5e","#bc4c7d","#2e4700","#bb93d9","#cb9704","#854d88","#e2d67d","#ff93d1","#d67218","#7a0017","#ffa265","#9aca71","#8A7C64","#599861")

individuals %>%
  filter(state_abb != 0, country != 0, country %in% top_ctrys,
         state_name %in% top_states) %>%
ggplot(aes(y = factor(country, top_ctrys), 
           fill = state_abb)) +
  geom_bar() +
  theme(axis.text.x=element_blank(),
        legend.title = element_text(size=12), 
        legend.text = element_text(size=11)) +
  labs(title = "Top Origins & Destinations", 
       y = "Country of Origin", 
       x = element_blank(), 
       fill = "Destination State") +
  #scale_fill_grey(start = .2, end = .9)
  #scale_fill_manual(values = palette2)
  scale_fill_viridis_d()

```







