---
title: "CAWC Origins, Languages & Destinations Report"
author: "Kendra Lyons"
date: "3/11/2022"
output: html_document
---

```{r setup, include=FALSE}
library(ggrepel)
library(knitr)
library(tidyverse)
library(usmap)
opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## Data Dates: 1/26/21 to 1/20/22

```{r data, echo=FALSE}

individuals <- read_csv("data/individual_all_clean_1_20_22.csv", na = c("", "NA")) %>% #
  rename("GroupID" = ...1)

countries <- drop_na(read_csv("data/country_counts_1.20.csv"))

languages <- drop_na(read_csv("data/language_counts_1.20.csv"))

destinations <- drop_na(read_csv("data/destination_counts_1.20.csv"))

```


## Countries of Origin

```{r countries, echo=FALSE}

# filter out countries with few arrivals
top_ctrys <-  countries$country[0:12]

# set plot theme
theme_set(theme_minimal(15)) 
#par(mfrow = c(1, 2))

# Arrivals by country over time dot plot
some_countries <- countries$country[countries$n > 3]

individuals %>%
  filter(country %in% some_countries) %>%
  ggplot(aes(x = arrival_date, 
             y = factor(country, rev(countries$country[1:23])))) +
  geom_point(alpha = .1) +
  labs(title = "Arrivals over time by origin country",
       x = element_blank(), 
       y = element_blank()) +
  scale_x_date(date_breaks = "1 month", 
               date_labels = "%b") 

# Top 12 countries of origin FW 
individuals %>%
  filter(country %in% top_ctrys) %>%
  ggplot(aes(x = arrival_date)) +
  geom_bar(show.legend = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  labs(title = "Daily arrivals, top origin countries", 
       x = element_blank(), 
       y = "Number of Individuals") + 
  scale_x_date(date_breaks = "3 month", 
               date_labels = "%b") + 
  facet_wrap(~factor(country, top_ctrys), scales = "free_y")


```

## Languages

```{r languages, echo=FALSE}

# plot arrivals of other language speakers over time
some_langs = languages$language[languages$n > 4]

individuals %>%
  filter(language %in% some_langs) %>%
  ggplot(aes(x = arrival_date, 
             y = factor(language, rev(some_langs)))) +
  geom_point(alpha = .2) +
  labs(title = "Arrivals over time by language spoken",
       x = element_blank(), 
       y = element_blank()) +
  scale_x_date(date_breaks = "1 month", 
               date_labels = "%b") 
  
```

## Destination States

```{r destmap, echo=FALSE}
# Add values of 0 for states with no travelers
destinations <- destinations %>%
  add_row(state_name = "Hawaii", n = 0, percent = 0.0) %>%
  add_row(state_name = "North Dakota", n = 0, percent = 0.0) %>%
  add_row(state_name = "Wyoming", n = 0, percent = 0.0) %>%
  rename("state" = state_name)

# get state centroids for labels
centroids <- read_csv("data/us_states_centroids.csv") %>%
  rename("state" = full)

# add centroid data to destination data ## MOVE THIS SECTION AND ABOVE TO CLEANING
map_destinations <- centroids %>%
  left_join(destinations)

# plot data on U.S. map with descriptive labels
plot_usmap(data = destinations, 
           values = "n") +
  theme(legend.position = "right") +
  scale_fill_continuous(name = "Guests",
                        low = "white", 
                        high = "darkgreen") +
  geom_label_repel(data = map_destinations, max.overlaps = 21,
            aes(x = x,
                y = y,
                label = paste(abbr, n)),
            size = 3) +
  labs(title = "Destinations of Casa Alitas guests")

```

```{r states, echo=FALSE}
# vector with top (12) destination states
top_states <- destinations$state[1:12]
popular_dests <- destinations$state[destinations$n>150]

individuals <- individuals %>%
  drop_na(state_name) 

individuals%>% # NA'S aren't removed from plot
  filter(state_name %in% popular_dests) %>%
  ggplot(aes(x = arrival_date, 
             y = factor(state_name, rev(popular_dests)))) +
  geom_point(alpha = .2, na.rm = TRUE) +
  labs(title = "Arrivals over time by destination state",
       x = element_blank(), 
       y = element_blank()) +
  scale_x_date(date_breaks = "1 month", 
               date_labels = "%b") 

# plot comparison of top origin countries and destination states
individuals %>%
  filter(state_abb != 0, country != 0, country %in% top_ctrys,
         state_name %in% top_states) %>%
ggplot(aes(y = factor(country, rev(top_ctrys)), 
           fill = state_abb)) +
  geom_bar() +
  theme(axis.text.x=element_blank(),
        #legend.title = element_text(size=12), 
        legend.text = element_text(size=10),
        legend.position = "top",
        legend.justification = 0) +
  labs(title = "Top origin countries and destination states", 
       y = element_blank(), 
       x = element_blank(), 
       fill = element_blank()) +
  guides(fill = guide_legend(nrow = 1, reverse = TRUE, 
                             label.position = "top")) +
  scale_fill_viridis_d()

```







